var GeoLocator=function(a){this.geoId=null;this.app=a;this.trailLocationMarker=this.mainLocationMarker=this.lastData=null};
GeoLocator.prototype.mapUserLocation=function(){navigator.geolocation?(null!==this.geoId?(this.app.showInfo("Oppdaterer din posisjon...",10),navigator.geolocation.clearWatch(this.geoId),this.geoId=null):this.app.showInfo("Henter din posisjon...",10),navigator.geolocation.getCurrentPosition(this.updatePosition.bind(this),this.geolocationFail.bind(this))):this.app.showInfo("Posisjondata ikke tigjengelig!",6)};
GeoLocator.prototype.geolocationFail=function(a){switch(a.code){case a.PERMISSION_DENIED:this.app.showInfo("Brukeren avsol foresp\u00f8rsel om posisjon.");break;case a.POSITION_UNAVAILABLE:this.app.showInfo("Posisjonsinformasjon ikke tilgjengelig.");break;case a.TIMEOUT:this.app.showInfo("Tidsavbrudd i forsp\u00f8rsel om posisjon.");break;default:this.app.showInfo("Posisjonsforesp\u00f8rsel: ukjent feil.")}};
GeoLocator.prototype.updatePosition=function(a){this.lastData={lat:a.coords.latitude,lng:a.coords.longitude};console.log(this.lastData);this.mainLocationMarker?(this.mainLocationMarker.setPosition(this.lastData),null===this.geoId&&(a=this.app.getClosestTrailStart(a.coords.latitude,a.coords.longitude),this.app.setClosestTrail(a),this.app.showInfo("Posisjon oppdatert<hr>N\u00e6rmeste sti: <b>"+a.getTitle()+"</b><br>Klikk her for \u00e5 \u00e5pne.",6))):(a=this.app.getClosestTrailStart(a.coords.latitude,
a.coords.longitude),this.app.setClosestTrail(a),this.app.showInfo("Posisjon funnet<hr>N\u00e6rmeste sti: <b>"+a.getTitle()+"</b><br>Klikk her for \u00e5 \u00e5pne.<br>Din posisjon oppdateres heretter automatisk",6),this.mainLocationMarker=new google.maps.Marker({position:this.lastData,map:this.app.getMainMap(),icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeColor:"#F00"}}));this.trailLocationMarker?this.trailLocationMarker.setPosition(this.lastData):this.trailLocationMarker=new google.maps.Marker({position:this.lastData,
map:this.app.getTrailMap(),icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeColor:"#F00"}});null===this.geoId&&(this.geoId=navigator.geolocation.watchPosition(this.updatePosition.bind(this)),this.app.getMainMap().setCenter(this.lastData))};var MtbMapApplication=function(a){this.config=a;this.infoTimeout=this.trailMap=this.mainMap=null;this.trails=[];this.currDetailTrail=null;this.show3d=!1;this.mainBounds=null;this.geoLocator=new GeoLocator(this);this.mapBg=this.closestTrail=null;this.mapBgActive=!1;this.toggleButton=null;this.updateStaticText();$("#closetrailinfo").click(this.closeTrailInfo.bind(this));$("#trail3dBtn").click(this.showTrail3d.bind(this));$("#trail2dBtn").click(this.showTrail2d.bind(this));$("#infopopup").click(this.infoPopupClicked.bind(this))};
MtbMapApplication.prototype.updateStaticText=function(){$("#infotextcontent").html(this.config.main.infoText+'<h2>mtbmaps.net</h2>M\u00e5let med mtbmaps.net er \u00e5 tilby en lettvekts webapplikasjon for navigasjon i typiske norske stinettverk som best\u00e5r av flere sm\u00e5 segmenter i motsetning til lange sammenhengende l\u00f8yper. Det er fokus p\u00e5 \u00e5 kunne finne inngangen p\u00e5 stiene.<br>L\u00f8sningen skal v\u00e6re enkel \u00e5 sette opp og krever ingen dynamisk serviersideteknologi.<br>Tilgjengelige omr\u00e5der: <br><ul><li><a href="https://www.mtbmaps.net?c=tungvekter">Arendal - Tungvekteren</a></li><li><a href="https://www.mtbmaps.net?c=asbie">Arendal - \u00c5sbieskogen</a></li></ul><br>'+
(mobilecheck()?"Du ser n\u00e5 p\u00e5 mobilutgaven av webapplikasjonen.":'Du ser n\u00e5 p\u00e5 desktoputgaven av webapplikasjonen. <a href="index_mobile.html?c='+(getUrlParameter("c")?getUrlParameter("c"):"tungvekter")+'&mobile=true">Mobilversjon</a>'));mobilecheck()||$("#headertext").html(mobilecheck()?this.config.main.mainHeaderMobile:this.config.main.mainHeaderDesktop)};MtbMapApplication.prototype.infoPopupClicked=function(){if(this.closestTrail)this.onMapElemClicked(this.closestTrail);this.hideInfo()};
MtbMapApplication.prototype.setClosestTrail=function(a){this.closestTrail=a};MtbMapApplication.prototype.getMainMap=function(){return this.mainMap};MtbMapApplication.prototype.getTrailMap=function(){return this.trailMap};MtbMapApplication.prototype.closeTrailInfo=function(){this.currDetailTrail.renderTo(this.mainMap,this.onMapElemClicked.bind(this));this.currDetailTrail=null;$("#trailwindow").fadeOut(500)};
MtbMapApplication.prototype.hideInfo=function(){null!=this.infoTimeout&&clearTimeout(this.infoTimeout);$("#infopopup").fadeOut(500)};MtbMapApplication.prototype.showInfo=function(a,b){b||(b=4);null!=this.infoTimeout&&clearTimeout(this.infoTimeout);$("#infopopup").html(a);$("#infopopup").fadeIn(500);this.infoTimeout=setTimeout(function(){$("#infopopup").fadeOut(500);this.infoTimeout=null}.bind(this),1E3*b)};
MtbMapApplication.prototype.initMap=function(){console.log("Setting up maps...");this.mainBounds=new google.maps.LatLngBounds;this.mainMap=new google.maps.Map(document.getElementById("map"),{mapTypeId:"hybrid",mapTypeControl:!1,disableDefaultUI:!0});this.config.hasOwnProperty("background")&&this.config.background.hasOwnProperty("pos")&&(this.mapBg=new google.maps.GroundOverlay(this.config.background.src,this.config.background.pos,{clickable:!1}),"false"!==localStorage["mtbmaps.settings.showMapBg"]&&
(this.mapBgActive=!0,this.mapBg.setMap(this.mainMap)));this.trailMap=new google.maps.Map(document.getElementById("trailmap"),{mapTypeId:"hybrid",mapTypeControl:!1,disableDefaultUI:!0});for(var a in this.config.markers)this.config.markers.hasOwnProperty(a)&&(new google.maps.Marker({position:this.config.markers[a].position,map:this.mainMap,title:this.config.markers[a].title,icon:this.config.markers[a].icon}),this.mainBounds.extend(new google.maps.LatLng(this.config.markers[a].position.lat,this.config.markers[a].position.lng)));
var b=this.config.trails.length;for(a=0;a<this.config.trails.length;a++){var c=new Trail(this.config.trails[a],this.config.main.levelColors);c.loadTrail(function(a){a.renderTo(this.mainMap,this.onMapElemClicked.bind(this));this.mainBounds.union(a.getBounds());b--;0===b&&(console.log("DONE - fit map..."),this.mainMap.fitBounds(this.mainBounds,0))}.bind(this));this.trails.push(c);console.log("Added trail "+c.getTitle())}this.addHelpOverlays();this.hideInfo()};
MtbMapApplication.prototype.getClosestTrailStart=function(a,b){for(var c=this.trails[0].distanceToStart(a,b),d=this.trails[0],e=1;e<this.trails.length;e++){var f=this.trails[e].distanceToStart(a,b);f<c&&(c=f,d=this.trails[e])}return d};MtbMapApplication.prototype.resetMainMap=function(){this.mainMap.fitBounds(this.mainBounds,0)};
MtbMapApplication.prototype.addHelpOverlays=function(){var a=document.createElement("div");a.style.background="rgba(255,255,255,.6)";a.style.padding="6px";a.style.borderRight="1px solid white";a.style.borderBottom="1px solid white";a.style.fontSize="16px";a.style.borderRadius="0 0 6px 0";a.index=1;a.innerHTML="<i style='font-weight:bold; color: "+this.config.main.levelColors[1]+";' class=\"fa fa-minus\"></i> Lett<br><i style='font-weight:bold; color: "+this.config.main.levelColors[2]+";' class=\"fa fa-minus\"></i> Middels<br><i style='font-weight:bold; color: "+
this.config.main.levelColors[3]+';\' class="fa fa-minus"></i> Vanskelig<hr><i style=\'color: #ffffff;\' class="fa fa-circle"></i> Start';mobilecheck()&&(a.innerHTML+="<br><i style='color: #f00;' class='fa fa-circle'></i> Deg");this.mainMap.controls[google.maps.ControlPosition.TOP_LEFT].push(a);a=document.createElement("div");if(mobilecheck()){var b=document.createElement("button");b.style.background="rgba(255,255,255,.6)";b.style.padding="12px";b.style.marginRight="10px";b.style.fontSize="16px";b.style.cursor=
"pointer";b.setAttribute("class","topButton");b.index=3;b.innerHTML='<i style="cursor:pointer; font-size: 34px;" class="fa fa-info-circle"></i>';b.onclick=function(){$("#infotext").fadeIn(500,function(){$("html, body").animate({scrollTop:0},"slow")})};a.appendChild(b);b=document.createElement("button");b.style.background="rgba(255,255,255,.6)";b.style.padding="12px";b.style.marginRight="10px";b.style.fontSize="16px";b.style.cursor="pointer";b.setAttribute("class","topButton");b.index=2;b.innerHTML=
'<i style="cursor:pointer; font-size: 34px;" class="fa fa-crosshairs"></i>';b.onclick=function(){this.geoLocator.mapUserLocation()}.bind(this);a.appendChild(b)}this.mapBg&&(this.toggleButton=document.createElement("button"),this.toggleButton.style.background="rgba(255,255,255,.6)",this.toggleButton.style.padding="12px",this.toggleButton.style.marginRight="10px",this.toggleButton.setAttribute("class","topButton"),this.toggleButton.style.fontSize="16px",this.toggleButton.style.cursor="pointer",this.toggleButton.innerHTML=
this.mapBgActive?'<i style="cursor:pointer; font-size: 34px;" class="fa fa-toggle-on"></i>':'<i style="cursor:pointer; font-size: 34px;" class="fa fa-toggle-off"></i>',this.toggleButton.onclick=this.toggleBackground.bind(this),a.appendChild(this.toggleButton));b=document.createElement("button");b.style.background="rgba(255,255,255,.6)";b.style.padding="12px";b.setAttribute("class","topButton");b.style.fontSize="16px";b.style.cursor="pointer";b.innerHTML='<i style="cursor:pointer; font-size: 34px;" class="fa fa-home"></i>';
b.onclick=this.resetMainMap.bind(this);a.appendChild(b);this.mainMap.controls[google.maps.ControlPosition.TOP_RIGHT].push(a)};
MtbMapApplication.prototype.toggleBackground=function(){this.mapBg.setMap(this.mapBgActive?null:this.mainMap);this.mapBgActive=!this.mapBgActive;this.toggleButton.innerHTML=this.mapBgActive?'<i style="cursor:pointer; font-size: 34px;" class="fa fa-toggle-on"></i>':'<i style="cursor:pointer; font-size: 34px;" class="fa fa-toggle-off"></i>';localStorage&&(localStorage["mtbmaps.settings.showMapBg"]=this.mapBgActive)};
MtbMapApplication.prototype.generateGraph3d=function(a){for(var b=new vis.DataSet,c=a.getCoords(),d=a.getAltitudes(),e=0,f=0;f<c.length;f++)b.add({id:e++,x:c[f].lng,y:c[f].lat,z:d[f],style:50});a={width:"100%",height:"100%",style:"bar-size",showPerspective:!0,showGrid:!1,showShadow:!1,keepAspectRatio:!0,verticalRatio:10>a.getHeightDiff()?.1:.2,xBarWidth:3E-4,yBarWidth:3E-4,xLabel:"",yLabel:"",zLabel:"moh",xValueLabel:function(a){return""},yValueLabel:function(a){return""}};new vis.Graph3d(document.getElementById("trailchart"),
b,a)};MtbMapApplication.prototype.generateGraph2d=function(a){var b=new vis.DataSet,c=a.getAltitudes();a=a.getDistances();for(var d=0,e=0;e<c.length;e++)d+=a[e],b.add({x:d,y:c[e]});new vis.Graph2d(document.getElementById("trailchart"),b,{width:"100%",height:"100%",moveable:!1,zoomable:!1,drawPoints:!1,style:"bar",showMajorLabels:!1})};MtbMapApplication.prototype.showTrail3d=function(){this.show3d=!0;$("#trail3dBtn").hide();$("#trail2dBtn").show();this.currDetailTrail&&($("#trailchart").empty(),this.generateGraph3d(this.currDetailTrail))};
MtbMapApplication.prototype.showTrail2d=function(){this.show3d=!1;$("#trail3dBtn").show();$("#trail2dBtn").hide();this.currDetailTrail&&($("#trailchart").empty(),this.generateGraph2d(this.currDetailTrail))};
MtbMapApplication.prototype.onMapElemClicked=function(a){this.currDetailTrail=a;$("#trailinfoheader").html(a.getTitle());$("#trailchart").empty();$("#entranceimg").attr("src","data/pics/start.jpg");$("#trailentrance").html(a.getFindStartText());$("#trailinfotext").html(a.getInfoText());$("#trailfacts").html('<p style="margin: 0; text-align:left;">Lengde: '+Math.floor(1E4*a.getLength())/10+'m<span style="float:right;">'+(mobilecheck()?"H\u00f8ydefor.":"H\u00f8ydeforskjell")+": "+Math.floor(10*a.getHeightDiff())/
10+"m</span></p>Vanskelighetsgrad: "+a.getLevelAsText());$("#trailwindow").fadeIn(500,function(){a.renderTo(this.trailMap);this.trailMap.fitBounds(a.getBounds(),6);this.show3d?this.generateGraph3d(a):this.generateGraph2d(a)}.bind(this))};var Trail=function(a,b){this.config=a;this.heightDiff=0;this.coordinates=[];this.altitudes=[];this.distances=[];this.clickCb=this.path=this.stopMarker=this.startMarker=null;this.levelColors=b;this.bounds=null};Trail.prototype.getInfoText=function(){return this.config.infoText};Trail.prototype.getFindStartText=function(){return this.config.findStartText};Trail.prototype.getLevel=function(){return this.config.level};Trail.prototype.getTitle=function(){return this.config.title};
Trail.prototype.getHeightDiff=function(){return this.heightDiff};Trail.prototype.getCoords=function(){return this.coordinates};Trail.prototype.getAltitudes=function(){return this.altitudes};Trail.prototype.getDistances=function(){return this.distances};Trail.prototype.getLength=function(){return this.path?this.path.inKm():0};Trail.prototype.getTrailColor=function(){if(this.levelColors.hasOwnProperty(this.config.level))return this.levelColors[this.config.level]};
Trail.prototype.getLevelAsText=function(){switch(this.config.level){case 2:return"Middles";case 3:return"H\u00f8y";default:return"Lav"}};Trail.prototype.getBounds=function(){return this.bounds};Trail.prototype.calcCrow=function(a,b,c,d){var e=(c-a)*Math.PI/180;b=(d-b)*Math.PI/180;a=a*Math.PI/180;c=c*Math.PI/180;a=Math.sin(e/2)*Math.sin(e/2)+Math.sin(b/2)*Math.sin(b/2)*Math.cos(a)*Math.cos(c);return 12742E3*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))};
Trail.prototype.parseGxp=function(a){var b=this,c=null,d=null;$(a).find("gpx").each(function(){$(this).find("trk").each(function(){var a=null,f=null;$(this).find("trkseg").each(function(){$(this).find("trkpt").each(function(){var h=parseFloat($(this).attr("lat")),k=parseFloat($(this).attr("lon"));b.coordinates.push({lat:h,lng:k});b.distances.push(null===a?0:b.calcCrow(a,f,h,k));b.bounds.extend(new google.maps.LatLng(h,k));a=h;f=k;var g=0;$(this).find("ele").each(function(){g=parseFloat($(this).text());
null===c?c=d=g:c>g?c=g:d<g&&(d=g)});b.altitudes.push(g)})})})});this.heightDiff=d-c};Trail.prototype.loadTrail=function(a){var b=this;this.bounds=new google.maps.LatLngBounds;$.ajax({type:"GET",url:this.config.url,cache:!1,dataType:"xml",success:function(c){b.parseGxp(c);a(b)},error:function(){console.error("Could not load trail info from "+this.config.url);a(b)}})};Trail.prototype.distanceToStart=function(a,b){return this.calcCrow(a,b,this.coordinates[0].lat,this.coordinates[0].lng)};
Trail.prototype.patchClicked=function(){this.clickCb&&this.clickCb(this)};
Trail.prototype.renderTo=function(a,b){this.startMarker?this.startMarker.setMap(a):(this.startMarker=new google.maps.Marker({position:this.coordinates[0],map:a,icon:{path:google.maps.SymbolPath.CIRCLE,scale:4,strokeColor:"#ffffff"},title:"START "+this.getTitle()}),this.startMarker.addListener("click",this.patchClicked.bind(this)));this.path?this.path.setMap(a):(this.path=new google.maps.Polyline({path:this.coordinates,geodesic:!0,map:a,strokeColor:this.getTrailColor(),strokeOpacity:.8,strokeWeight:6}),
this.path.addListener("click",this.patchClicked.bind(this)));this.clickCb=b};
