var GeoLocator=function(a){this.geoId=null;this.app=a;this.trailLocationMarker=this.mainLocationMarker=this.lastData=null};
GeoLocator.prototype.mapUserLocation=function(){navigator.geolocation?(null!==this.geoId?(this.app.showInfo("Oppdaterer din posisjon...",10),navigator.geolocation.clearWatch(this.geoId),this.geoId=null):this.app.showInfo("Henter din posisjon...",10),navigator.geolocation.getCurrentPosition(this.updatePosition.bind(this),this.geolocationFail.bind(this))):this.app.showInfo("Posisjondata ikke tigjengelig!",6)};
GeoLocator.prototype.geolocationFail=function(a){switch(a.code){case a.PERMISSION_DENIED:this.app.showInfo("User denied the request for Geolocation.");break;case a.POSITION_UNAVAILABLE:this.app.showInfo("Location information is unavailable.");break;case a.TIMEOUT:this.app.showInfo("The request to get user location timed out.");break;default:this.app.showInfo("An unknown error occurred.")}};
GeoLocator.prototype.updatePosition=function(a){this.lastData={lat:a.coords.latitude,lng:a.coords.longitude};console.log(this.lastData);this.mainLocationMarker?(this.mainLocationMarker.setPosition(this.lastData),null===this.geoId&&this.app.showInfo("Posisjon oppdatert<hr>Din posisjon oppdateres ogs\u00e5 automatisk",5)):(this.app.showInfo("Posisjon mottat<hr>Din posisjon vil etter dette oppdateres automatisk",6),this.mainLocationMarker=new google.maps.Marker({position:this.lastData,map:this.app.getMainMap(),
icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeColor:"#F00"}}));this.trailLocationMarker?this.trailLocationMarker.setPosition(this.lastData):this.trailLocationMarker=new google.maps.Marker({position:this.lastData,map:this.app.getTrailMap(),icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeColor:"#F00"}});null===this.geoId&&(this.geoId=navigator.geolocation.watchPosition(this.updatePosition.bind(this)),this.app.getMainMap().setCenter(this.lastData))};var MtbMapApplication=function(a,b,d){this.config={main:a,markers:b,trails:d};this.infoTimeout=this.trailMap=this.mainMap=null;this.trails=[];this.currDetailTrail=null;this.updateStaticText();$("#closetrailinfo").click(this.closeTrailInfo.bind(this))};
MtbMapApplication.prototype.updateStaticText=function(){$("#infotextcontent").html(this.config.main.infoText+'<h2>mtbmaps.net</h2>M\u00e5let med mtbmaps.net er \u00e5 tilby en lettvekts webapplikasjon for navigasjon i typiske norske stinettverk som best\u00e5r av flere sm\u00e5 segmenter i motsetning til lange sammenhengende l\u00f8yper. Det er fokus p\u00e5 \u00e5 kunne finne inngangen p\u00e5 stiene.<br>L\u00f8sningen skal v\u00e6re enkel \u00e5 sette opp og krever ingen dynamisk serviersideteknologi.<br>Du kan forke prosjektet p\u00e5 <a href="https://github.com/cynodia/ast-maps">GitHub</a>.<br>'+(mobilecheck()?
"Du ser n\u00e5 p\u00e5 mobilutgaven av webapplikasjonen.":'Du ser n\u00e5 p\u00e5 desktoputgaven av webapplikasjonen. <a href="index_mobile.html">Mobilversjon</a>'));$("#headertext").html(mobilecheck()?this.config.main.mainHeaderMobile:this.config.main.mainHeaderDesktop)};MtbMapApplication.prototype.getMainMap=function(){return this.mainMap};MtbMapApplication.prototype.getTrailMap=function(){return this.trailMap};
MtbMapApplication.prototype.closeTrailInfo=function(){this.currDetailTrail.renderTo(this.mainMap);this.currDetailTrail=null;$("#trailwindow").fadeOut(750)};MtbMapApplication.prototype.hideInfo=function(){null!=this.infoTimeout&&clearTimeout(this.infoTimeout);$("#infopopup").fadeOut(750)};
MtbMapApplication.prototype.showInfo=function(a,b){b||(b=4);$("#infopopup").html(a);$("#infopopup").fadeIn(750);this.infoTimeout=setTimeout(function(){$("#infopopup").fadeOut(750);this.infoTimeout=null}.bind(this),1E3*b)};
MtbMapApplication.prototype.initMap=function(){console.log("Setting up maps...");this.mainMap=new google.maps.Map(document.getElementById("map"),{zoom:this.config.main.mapZoom,center:this.config.main.mapCenter,mapTypeId:"hybrid",mapTypeControl:!1,disableDefaultUI:!0});this.trailMap=new google.maps.Map(document.getElementById("trailmap"),{zoom:16,center:this.config.main.mapCenter,mapTypeId:"hybrid",mapTypeControl:!1,disableDefaultUI:!0});for(var a in this.config.markers)this.config.markers.hasOwnProperty(a)&&
new google.maps.Marker({position:this.config.markers[a].position,map:this.mainMap,title:this.config.markers[a].title,icon:this.config.markers[a].icon});for(var b in this.config.trails)this.config.trails.hasOwnProperty(b)&&(a=new Trail(this.config.trails[b]),a.loadTrail(function(a){a.renderTo(this.mainMap,this.onMapElemClicked.bind(this))}.bind(this)),this.trails.push(a),console.log("Added trail "+b));this.addHelpOverlays();this.hideInfo()};
MtbMapApplication.prototype.resetMainMap=function(){this.mainMap.setZoom(this.config.main.mapZoom);this.mainMap.setCenter(this.config.main.mapCenter)};
MtbMapApplication.prototype.addHelpOverlays=function(){var a=document.createElement("div");a.style.background="rgba(255,255,255,.6)";a.style.padding="6px";a.style.fontSize="16px";a.index=1;a.innerHTML="<i style='font-weight:bold; color: #00bb00;' class=\"fa fa-minus\"></i> Lett<br><i style='font-weight:bold; color: #4444ee;' class=\"fa fa-minus\"></i> Middels<br><i style='font-weight:bold; color: #000000;' class=\"fa fa-minus\"></i> Vanskelig<hr><i style='color: #00f;' class=\"fa fa-circle\"></i> Start<br><i style='color: #0f0;' class=\"fa fa-circle\"></i> Slutt<br><i style='color: #f00;' class=\"fa fa-circle\"></i> Deg";this.mainMap.controls[google.maps.ControlPosition.TOP_LEFT].push(a);
a=document.createElement("button");a.setAttribute("id","mapResetBtn");a.style.background="rgba(255,255,255,.6)";a.style.padding="12px";a.style.marginTop="40px";a.style.fontSize="16px";a.style.cursor="pointer";a.innerHTML='<i style="cursor:pointer; font-size: 34px;" class="fa fa-home"></i>';a.onclick=this.resetMainMap.bind(this);this.mainMap.controls[google.maps.ControlPosition.TOP_RIGHT].push(a)};
MtbMapApplication.prototype.onMapElemClicked=function(a){this.currDetailTrail=a;$("html, body").animate({scrollTop:0},"slow");$("#trailinfoheader").html(a.getTitle());$("#chart3d").empty();$("#elevationchart").empty();for(var b=0,d=new vis.DataSet,c=a.getCoords(),e=a.getAltitudes(),f=0;f<c.length;f++)d.add({id:b++,x:c[f].lng,y:c[f].lat,z:e[f],style:50});b={width:"100%",height:"100%",style:"bar-size",showPerspective:!0,showGrid:!1,showShadow:!1,keepAspectRatio:!0,verticalRatio:10>a.getHeightDiff()?
.1:.2,xBarWidth:3E-4,yBarWidth:3E-4,xLabel:"",yLabel:"",zLabel:"moh",xValueLabel:function(a){return""},yValueLabel:function(a){return""}};this.trailMap.setCenter(new google.maps.LatLng(c[0].lat,c[0].lng));a.renderTo(this.trailMap);c='<img class="shadowed" width="100%" align="center" src="data/pics/start.jpg"/><br>'+a.getFindStartText();$("#trailentrance").html(c);$("#trailinfotext").html(a.getInfoText());$("#trailwindow").fadeIn(750);$("#trailfacts").html('<p style="margin: 0; text-align:left;">Lengde: '+
Math.floor(1E4*a.getLength())/10+'m<span style="float:right;">H\u00f8ydefor.: '+Math.floor(10*a.getHeightDiff())/10+"m</span></p>Vanskelighetsgrad: "+a.getLevelAsText());new vis.Graph3d(document.getElementById("chart3d"),d,b)};var Trail=function(a,b){this.config=a;this.gMap=b;this.heightDiff=0;this.coordinates=[];this.altitudes=[];this.clickCb=this.path=this.stopMarker=this.startMarker=null};Trail.prototype.getInfoText=function(){return this.config.infoText};Trail.prototype.getFindStartText=function(){return this.config.findStartText};Trail.prototype.getLevel=function(){return this.config.level};Trail.prototype.getTitle=function(){return this.config.title};Trail.prototype.getHeightDiff=function(){return this.heightDiff};
Trail.prototype.getCoords=function(){return this.coordinates};Trail.prototype.getAltitudes=function(){return this.altitudes};Trail.prototype.getLength=function(){return this.path?this.path.inKm():0};Trail.prototype.getTrailColor=function(){switch(this.config.level){case 2:return"#00ff00";case 3:return"#000000";default:return"#0000ff"}};Trail.prototype.getLevelAsText=function(){switch(this.config.level){case 2:return"Middles";case 3:return"H\u00f8y";default:return"Lav"}};
Trail.prototype.loadTrail=function(a){var b=this;$.ajax({type:"GET",url:this.config.url,cache:!1,dataType:"xml",success:function(d){var c=null,e=null;$(d).find("gpx").each(function(){$(this).find("trk").each(function(){$(this).find("trkseg").each(function(){$(this).find("trkpt").each(function(){b.coordinates.push({lat:parseFloat($(this).attr("lat")),lng:parseFloat($(this).attr("lon"))});var a=0;$(this).find("ele").each(function(){a=parseFloat($(this).text());null===c?c=e=a:c>a?c=a:e<a&&(e=a)});b.altitudes.push(a)})})})});
b.heightDiff=e-c;a(b)}})};Trail.prototype.patchClicked=function(){this.clickCb&&this.clickCb(this)};
Trail.prototype.renderTo=function(a,b){this.startMarker?this.startMarker.setMap(a):(this.startMarker=new google.maps.Marker({position:this.coordinates[0],map:a,icon:{path:google.maps.SymbolPath.CIRCLE,scale:5,strokeColor:"#00F"},title:"START "+this.getTitle()}),this.startMarker.addListener("click",this.patchClicked.bind(this)));this.stopMarker?this.stopMarker.setMap(a):(this.stopMarker=new google.maps.Marker({position:this.coordinates[this.coordinates.length-1],map:a,icon:{path:google.maps.SymbolPath.CIRCLE,
scale:5,strokeColor:"#0F0"},title:"FINISH "+this.getTitle()}),this.stopMarker.addListener("click",this.patchClicked.bind(this)));this.path?this.path.setMap(a):(this.path=new google.maps.Polyline({path:this.coordinates,geodesic:!0,map:a,strokeColor:this.getTrailColor(),strokeOpacity:.8,strokeWeight:6}),this.path.addListener("click",this.patchClicked.bind(this)));this.clickCb=b};
