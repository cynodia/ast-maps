var GeoLocator=function(a){this.geoId=null;this.app=a;this.trailLocationMarker=this.mainLocationMarker=this.lastData=null};
GeoLocator.prototype.mapUserLocation=function(){navigator.geolocation?(null!==this.geoId?(this.app.showInfo("Oppdaterer din posisjon...",10),navigator.geolocation.clearWatch(this.geoId),this.geoId=null):this.app.showInfo("Henter din posisjon...",10),navigator.geolocation.getCurrentPosition(this.updatePosition.bind(this),this.geolocationFail.bind(this))):this.app.showInfo("Posisjondata ikke tigjengelig!",6)};
GeoLocator.prototype.geolocationFail=function(a){switch(a.code){case a.PERMISSION_DENIED:this.app.showInfo("Brukeren avsol foresp\u00f8rsel om posisjon.");break;case a.POSITION_UNAVAILABLE:this.app.showInfo("Posisjonsinformasjon ikke tilgjengelig.");break;case a.TIMEOUT:this.app.showInfo("Tidsavbrudd i forsp\u00f8rsel om posisjon.");break;default:this.app.showInfo("Posisjonsforesp\u00f8rsel: ukjent feil.")}};
GeoLocator.prototype.updatePosition=function(a){this.lastData={lat:a.coords.latitude,lng:a.coords.longitude};console.log(this.lastData);this.mainLocationMarker?(this.mainLocationMarker.setPosition(this.lastData),null===this.geoId&&this.app.showInfo("Posisjon oppdatert<hr>Din posisjon oppdateres ogs\u00e5 automatisk",5)):(this.app.showInfo("Posisjon mottat<hr>Din posisjon vil etter dette oppdateres automatisk",6),this.mainLocationMarker=new google.maps.Marker({position:this.lastData,map:this.app.getMainMap(),
icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeColor:"#F00"}}));this.trailLocationMarker?this.trailLocationMarker.setPosition(this.lastData):this.trailLocationMarker=new google.maps.Marker({position:this.lastData,map:this.app.getTrailMap(),icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeColor:"#F00"}});null===this.geoId&&(this.geoId=navigator.geolocation.watchPosition(this.updatePosition.bind(this)),this.app.getMainMap().setCenter(this.lastData))};var MtbMapApplication=function(a){this.config=a;this.infoTimeout=this.trailMap=this.mainMap=null;this.trails=[];this.currDetailTrail=null;this.show3d=!1;this.geoLocator=new GeoLocator(this);this.updateStaticText();$("#closetrailinfo").click(this.closeTrailInfo.bind(this));$("#trail3dBtn").click(this.showTrail3d.bind(this));$("#trail2dBtn").click(this.showTrail2d.bind(this))};
MtbMapApplication.prototype.updateStaticText=function(){$("#infotextcontent").html(this.config.main.infoText+'<h2>mtbmaps.net</h2>M\u00e5let med mtbmaps.net er \u00e5 tilby en lettvekts webapplikasjon for navigasjon i typiske norske stinettverk som best\u00e5r av flere sm\u00e5 segmenter i motsetning til lange sammenhengende l\u00f8yper. Det er fokus p\u00e5 \u00e5 kunne finne inngangen p\u00e5 stiene.<br>L\u00f8sningen skal v\u00e6re enkel \u00e5 sette opp og krever ingen dynamisk serviersideteknologi.<br>Du kan forke prosjektet p\u00e5 <a href="https://github.com/cynodia/ast-maps">GitHub</a>.<br>'+(mobilecheck()?
"Du ser n\u00e5 p\u00e5 mobilutgaven av webapplikasjonen.":'Du ser n\u00e5 p\u00e5 desktoputgaven av webapplikasjonen. <a href="index_mobile.html">Mobilversjon</a>'));mobilecheck()||$("#headertext").html(mobilecheck()?this.config.main.mainHeaderMobile:this.config.main.mainHeaderDesktop)};MtbMapApplication.prototype.getMainMap=function(){return this.mainMap};MtbMapApplication.prototype.getTrailMap=function(){return this.trailMap};
MtbMapApplication.prototype.closeTrailInfo=function(){this.currDetailTrail.renderTo(this.mainMap,this.onMapElemClicked.bind(this));this.currDetailTrail=null;$("#trailwindow").fadeOut(750)};MtbMapApplication.prototype.hideInfo=function(){null!=this.infoTimeout&&clearTimeout(this.infoTimeout);$("#infopopup").fadeOut(750)};
MtbMapApplication.prototype.showInfo=function(a,b){b||(b=4);$("#infopopup").html(a);$("#infopopup").fadeIn(750);this.infoTimeout=setTimeout(function(){$("#infopopup").fadeOut(750);this.infoTimeout=null}.bind(this),1E3*b)};
MtbMapApplication.prototype.initMap=function(){console.log("Setting up maps...");this.mainMap=new google.maps.Map(document.getElementById("map"),{zoom:this.config.main.mapZoom,center:this.config.main.mapCenter,mapTypeId:"hybrid",mapTypeControl:!1,disableDefaultUI:!0});this.trailMap=new google.maps.Map(document.getElementById("trailmap"),{zoom:16,center:this.config.main.mapCenter,mapTypeId:"hybrid",mapTypeControl:!1,disableDefaultUI:!0});for(var a in this.config.markers)this.config.markers.hasOwnProperty(a)&&
new google.maps.Marker({position:this.config.markers[a].position,map:this.mainMap,title:this.config.markers[a].title,icon:this.config.markers[a].icon});for(a=0;a<this.config.trails.length;a++){var b=new Trail(this.config.trails[a],this.config.main.levelColors);b.loadTrail(function(a){a.renderTo(this.mainMap,this.onMapElemClicked.bind(this))}.bind(this));this.trails.push(b);console.log("Added trail "+b.getTitle())}this.addHelpOverlays();this.hideInfo()};
MtbMapApplication.prototype.resetMainMap=function(){this.mainMap.setZoom(this.config.main.mapZoom);this.mainMap.setCenter(this.config.main.mapCenter)};
MtbMapApplication.prototype.addHelpOverlays=function(){var a=document.createElement("div");a.style.background="rgba(255,255,255,.6)";a.style.padding="6px";a.style.borderRight="1px solid white";a.style.borderBottom="1px solid white";a.style.fontSize="16px";a.style.borderRadius="0 0 6px 0";a.index=1;a.innerHTML="<i style='font-weight:bold; color: "+this.config.main.levelColors[1]+";' class=\"fa fa-minus\"></i> Lett<br><i style='font-weight:bold; color: "+this.config.main.levelColors[2]+";' class=\"fa fa-minus\"></i> Middels<br><i style='font-weight:bold; color: "+
this.config.main.levelColors[3]+';\' class="fa fa-minus"></i> Vanskelig<hr><i style=\'color: #ffffff;\' class="fa fa-circle"></i> Start';mobilecheck()&&(a.innerHTML+="<br><i style='color: #f00;' class='fa fa-circle'></i> Deg");this.mainMap.controls[google.maps.ControlPosition.TOP_LEFT].push(a);a=document.createElement("div");if(mobilecheck()){var b=document.createElement("button");b.style.background="rgba(255,255,255,.6)";b.style.padding="12px";b.style.marginRight="10px";b.style.fontSize="16px";b.style.cursor=
"pointer";b.setAttribute("class","topButton");b.index=3;b.innerHTML='<i style="cursor:pointer; font-size: 34px;" class="fa fa-info-circle"></i>';b.onclick=function(){$("#infotext").fadeIn(750,function(){$("html, body").animate({scrollTop:0},"slow")})};a.appendChild(b);b=document.createElement("button");b.style.background="rgba(255,255,255,.6)";b.style.padding="12px";b.style.marginRight="10px";b.style.fontSize="16px";b.style.cursor="pointer";b.setAttribute("class","topButton");b.index=2;b.innerHTML=
'<i style="cursor:pointer; font-size: 34px;" class="fa fa-crosshairs"></i>';b.onclick=function(){this.geoLocator.mapUserLocation()}.bind(this);a.appendChild(b)}b=document.createElement("button");b.style.background="rgba(255,255,255,.6)";b.style.padding="12px";b.setAttribute("class","topButton");b.style.fontSize="16px";b.style.cursor="pointer";b.innerHTML='<i style="cursor:pointer; font-size: 34px;" class="fa fa-home"></i>';b.onclick=this.resetMainMap.bind(this);a.appendChild(b);this.mainMap.controls[google.maps.ControlPosition.TOP_RIGHT].push(a)};
MtbMapApplication.prototype.generateGraph3d=function(a){for(var b=new vis.DataSet,c=a.getCoords(),e=a.getAltitudes(),d=0,f=0;f<c.length;f++)b.add({id:d++,x:c[f].lng,y:c[f].lat,z:e[f],style:50});a={width:"100%",height:"100%",style:"bar-size",showPerspective:!0,showGrid:!1,showShadow:!1,keepAspectRatio:!0,verticalRatio:10>a.getHeightDiff()?.1:.2,xBarWidth:3E-4,yBarWidth:3E-4,xLabel:"",yLabel:"",zLabel:"moh",xValueLabel:function(a){return""},yValueLabel:function(a){return""}};new vis.Graph3d(document.getElementById("trailchart"),
b,a)};MtbMapApplication.prototype.generateGraph2d=function(a){var b=new vis.DataSet,c=a.getAltitudes();a=a.getDistances();for(var e=0,d=0;d<c.length;d++)e+=a[d],b.add({x:e,y:c[d]});new vis.Graph2d(document.getElementById("trailchart"),b,{width:"100%",height:"100%",moveable:!1,zoomable:!1,drawPoints:!1,style:"bar",showMajorLabels:!1})};MtbMapApplication.prototype.showTrail3d=function(){this.show3d=!0;$("#trail3dBtn").hide();$("#trail2dBtn").show();this.currDetailTrail&&($("#trailchart").empty(),this.generateGraph3d(this.currDetailTrail))};
MtbMapApplication.prototype.showTrail2d=function(){this.show3d=!1;$("#trail3dBtn").show();$("#trail2dBtn").hide();this.currDetailTrail&&($("#trailchart").empty(),this.generateGraph2d(this.currDetailTrail))};
MtbMapApplication.prototype.onMapElemClicked=function(a){this.currDetailTrail=a;$("html, body").animate({scrollTop:0},"slow");$("#trailinfoheader").html(a.getTitle());$("#trailchart").empty();var b=a.getCoords();this.trailMap.setCenter(new google.maps.LatLng(b[0].lat,b[0].lng));a.renderTo(this.trailMap);b='<img class="shadowed" width="100%" align="center" src="data/pics/start.jpg"/><br>'+a.getFindStartText();$("#trailentrance").html(b);$("#trailinfotext").html(a.getInfoText());$("#trailfacts").html('<p style="margin: 0; text-align:left;">Lengde: '+
Math.floor(1E4*a.getLength())/10+'m<span style="float:right;">'+(mobilecheck()?"H\u00f8ydefor.":"H\u00f8ydeforskjell")+": "+Math.floor(10*a.getHeightDiff())/10+"m</span></p>Vanskelighetsgrad: "+a.getLevelAsText());$("#trailwindow").fadeIn(750,function(){this.show3d?this.generateGraph3d(a):this.generateGraph2d(a)}.bind(this))};var Trail=function(a,b){this.config=a;this.heightDiff=0;this.coordinates=[];this.altitudes=[];this.distances=[];this.clickCb=this.path=this.stopMarker=this.startMarker=null;this.levelColors=b};Trail.prototype.getInfoText=function(){return this.config.infoText};Trail.prototype.getFindStartText=function(){return this.config.findStartText};Trail.prototype.getLevel=function(){return this.config.level};Trail.prototype.getTitle=function(){return this.config.title};Trail.prototype.getHeightDiff=function(){return this.heightDiff};
Trail.prototype.getCoords=function(){return this.coordinates};Trail.prototype.getAltitudes=function(){return this.altitudes};Trail.prototype.getDistances=function(){return this.distances};Trail.prototype.getLength=function(){return this.path?this.path.inKm():0};Trail.prototype.getTrailColor=function(){if(this.levelColors.hasOwnProperty(this.config.level))return this.levelColors[this.config.level]};
Trail.prototype.getLevelAsText=function(){switch(this.config.level){case 2:return"Middles";case 3:return"H\u00f8y";default:return"Lav"}};Trail.prototype.calcCrow=function(a,b,c,e){var d=(c-a)*Math.PI/180;b=(e-b)*Math.PI/180;a=a*Math.PI/180;c=c*Math.PI/180;a=Math.sin(d/2)*Math.sin(d/2)+Math.sin(b/2)*Math.sin(b/2)*Math.cos(a)*Math.cos(c);return 12742E3*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))};
Trail.prototype.loadTrail=function(a){var b=this;$.ajax({type:"GET",url:this.config.url,cache:!1,dataType:"xml",success:function(c){var e=null,d=null,f=null,h=null;$(c).find("gpx").each(function(){$(this).find("trk").each(function(){$(this).find("trkseg").each(function(){$(this).find("trkpt").each(function(){var a=parseFloat($(this).attr("lat")),c=parseFloat($(this).attr("lon"));b.coordinates.push({lat:a,lng:c});b.distances.push(null===f?0:b.calcCrow(f,h,a,c));f=a;h=c;var g=0;$(this).find("ele").each(function(){g=
parseFloat($(this).text());null===e?e=d=g:e>g?e=g:d<g&&(d=g)});b.altitudes.push(g)})})})});b.heightDiff=d-e;a(b)}})};Trail.prototype.patchClicked=function(){this.clickCb&&this.clickCb(this)};
Trail.prototype.renderTo=function(a,b){this.startMarker?this.startMarker.setMap(a):(this.startMarker=new google.maps.Marker({position:this.coordinates[0],map:a,icon:{path:google.maps.SymbolPath.CIRCLE,scale:4,strokeColor:"#ffffff"},title:"START "+this.getTitle()}),this.startMarker.addListener("click",this.patchClicked.bind(this)));this.path?this.path.setMap(a):(this.path=new google.maps.Polyline({path:this.coordinates,geodesic:!0,map:a,strokeColor:this.getTrailColor(),strokeOpacity:.8,strokeWeight:6}),
this.path.addListener("click",this.patchClicked.bind(this)));this.clickCb=b};
